import os, json, csv
from time import time

THRESHOLD_SCORE = 10

def getmaltyp(data, av):
    # Check if av is in list of anti-virus scanners
    if av in data['scans'].keys():
        # Check if av detect sample as positive
        if data['scans'][av]['detected']:
            typ = data['scans'][av]['result']
            return typ, 1
        # 'Not detected': av does not detect sample as malicious
        else:
            return "not detected", 0
    # 'Not results': av is not in the list of anti-virus scanners
    else:
        return "no results", 0

if __name__ == "__main__":
    # Dir containing the virustotal reports
    json_reports_dir = "../json_reports_9490"
    # List of anti-virus scanners to retrieve results from
    av_scanners = ["Malwarebytes", "Microsoft", "Sophos", "Symantec", "TrendMicro"]
    # Create and open csv file to save the results
    csvfile = open("check{}.csv".format(len(av_scanners)), "w+")
    writer = csv.writer(csvfile)
    # Write the headers
    writer.writerow(["sha1", "Malwarebytes", "Microsoft", "Sophos", "Symantec", "TrendMicro"])
    # Counters to keep track of number of samples with results from each scanner
    success_counter = [0 for i in range(len(av_scanners))]
    T0 = time()
    # Get the scanner result for each sample
    for f in os.listdir(json_reports_dir):
        file_path = os.path.join(json_reports_dir, f)
        # Open and load virustotal report
        with open(file_path) as jfile:
             data = json.load(jfile)
        # Get the malicious score; number of scanners that detect this sample as malicious
        score = int((data['positives']/data['total'])*100)
        # Detected as malware if malicious score >= THRESHOLD_SCORE
        if score >= THRESHOLD_SCORE:
            to_write = [data['sha1']]
            for i in range(len(av_scanners)):
                result, success = getmaltyp(data, av_scanners[i])
                to_write.append(result)
                if success:
                    success_counter[i]+=1
            writer.writerow(to_write)
        # 'Not a malware': Sample is not detected as malware if malicious score < THRESHOLD_SCORE
        else:
            writer.writerow([data['sha1'], "Not a malware; score={}".format(score)])
            
    csvfile.close()
    print("Done in {}s".format(time()-T0))
    print("Number of samples with malware types;")
    print("Malwarebytes: {}, Microsoft: {}, Sophos: {}, Symantec: {}, TrendMicro: {}".format(success_counter[0], success_counter[1], success_counter[2], success_counter[3], success_counter[4]))

